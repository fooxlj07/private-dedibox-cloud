# /etc/nftables.d/input-chain.nft

# Define the input chain 
table inet filter {
    chain input {
        type filter hook input priority 0; policy drop;

        # Allow loopback traffic
        iif lo accept

        # Allow established and related connections
        ct state established,related accept

        # Allow incoming SSH from localhost
        tcp dport 22 ip saddr {{ local_public_ip }} accept
        
        # Allow incoming ip from localhost
        ip saddr {{ local_public_ip }} tcp dport 8006 accept
        
        # Allow private ip to go through
    {% for host in groups['server'] if host != inventory_hostname %}
        ip saddr {{ hostvars[host]['priv_ip'] }} accept
    {%  endfor %}

        # All the public ip to go through
    {% for host in public_ip_addresses %}
        ip saddr {{ host }} accept
    {%  endfor %}
        icmp type echo-request accept
        ip saddr {{ vpn_subnet }} udp dport 5404 accept
        ip saddr {{ vpn_subnet }} udp dport 5405 accept
    }
}